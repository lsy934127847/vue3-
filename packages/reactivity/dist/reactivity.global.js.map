{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["export const isObject = (val) => typeof val == \"object\" && val !== null;\r\nexport const isNumber = (val) => typeof val == \"number\";\r\nexport const isFunction = (val) => typeof val == \"function\";\r\nexport const isString = (val) => typeof val == \"string\";\r\nexport const isArray =Array.isArray;\r\nexport const isBoolean = (val) => typeof val == \"boolean\";\r\nexport const extend = Object.assign;\r\n\r\nexport const hasOwn = (target,key) => Object.prototype.hasOwnProperty.call(target,key)\r\nexport const hasChanged =(oldValue,value) =>oldValue !== value\r\nexport const isInteger = (key) => parseInt(key) + \"\" === key","import { isArray, isInteger } from \"@vue/shared\";\r\n\r\nexport function effect(fn,options:any = {}){\r\n\r\n let effect  = createReactiveEffect(fn,options)\r\n if(!options.lazy){\r\n    effect();\r\n }\r\n\r\n return effect\r\n}\r\nlet uid= 0\r\nlet activeEffect\r\nfunction createReactiveEffect(fn,options){\r\n\r\n\r\n     const effect = function(){\r\n        activeEffect = effect\r\n        fn()  // 执行用户传入的函数时 会执行get\r\n        // activeEffect = null\r\n     }\r\n     effect.id = uid++  // 每一个effect都有一个唯一的标识(watcher)\r\n     effect._isEffect = true\r\n     effect.raw = fn\r\n     effect.deps = {}\r\n     effect.options = options\r\n     return effect\r\n}\r\n\r\nconst targetMap = new WeakMap()\r\nexport function track(target,types,key){\r\n\r\n   if(!activeEffect){\r\n       // 说明取值操作时再effect之外操作的\r\n       return \r\n   }\r\n\r\n  let deepsMap =   targetMap.get(target)\r\n  if(!deepsMap){\r\n    targetMap.set(target,(deepsMap = new Map()))\r\n  }\r\n  let dep =  deepsMap.get(key)\r\n  if(!dep){\r\n    deepsMap.set(key,(dep = new Set))\r\n  }\r\n\r\n  if(!dep.has(activeEffect)){\r\n    dep.add(activeEffect)\r\n  }\r\n}\r\n\r\nexport function trigger(target,key,value,type){\r\n\r\n    let deepsMap = targetMap.get(target)\r\n    if(!deepsMap){\r\n            return \r\n    }\r\n    // 如果修改的是数组 并且改的是长度 \r\n    if(isArray(target) && key == \"length\"){\r\n          deepsMap.forEach( (dep,key) =>{\r\n              if(key == \"length\" || value < key){\r\n                  dep.forEach( effects =>effects())\r\n              }\r\n          })\r\n    }else {\r\n        if(type == \"add\"){\r\n            //新增逻辑 需要触发更新\r\n                if(isArray(target) && isInteger(key)){\r\n                    let effects = deepsMap.get(\"length\")\r\n                    effects && effects.forEach(effect =>effect())\r\n                }\r\n        }\r\n        const effects = deepsMap.get(key)\r\n\r\n        effects && effects.forEach( (effect) =>{\r\n            effect()\r\n        })\r\n    }\r\n  \r\n   // activeEffect()\r\n}","import { hasChanged, hasOwn, isArray, isInteger, isObject } from \"../../shared/src/index\";\r\nimport { reactive, readonly } from \"./reactive\";\r\nimport { track, trigger } from \"./effect\"\r\nconst get = createGetter();\r\nconst readonlyGet = createGetter(true); // 仅读get\r\nconst shallowGet = createGetter(false, true); //\r\nconst shallowReadonlyGet = createGetter(true, true);\r\n\r\nconst set = createSetter()\r\n\r\n\r\nfunction createSetter(){\r\n  return function set(target,key,value,receiver){\r\n\r\n    let oldValue = target[key]\r\n\r\n    let hadKey =  isArray(target) && isInteger(key) ? key < target.length :hasOwn(target,key)\r\n\r\n    \r\n\r\n    let res = Reflect.set(target,key,value,receiver)\r\n\r\n    if(!hadKey) {\r\n      // 新增\r\n   }else if(hasChanged(oldValue,value)){\r\n     trigger(target,key,value,\"add\")\r\n   }\r\n\r\n  \r\n    console.log(\"res\",res)\r\n    // 触发视图更新\r\n     return res\r\n  }\r\n}\r\n\r\nfunction createGetter(isReadonly = false, shallow = false) {\r\n  // 目标 属性 代理对象\r\n  return function get(target, key, receiver) {\r\n    let res = Reflect.get(target, key, receiver);\r\n\r\n    if (!isReadonly) {\r\n      // 不是仅读 才去搜集依赖\r\n      track(target,\"get\",key)\r\n    }\r\n    if (shallow) {\r\n      return res;\r\n    }\r\n\r\n    if (isObject(res)) {  // 如果是对象就递归代理 当用到这个对象的时候才去代理\r\n      // {name:\"lsy\",age:{p1:25}} 当取到age的时候才去代理\r\n      return isReadonly ? readonly(res) : reactive(res); // 懒代理\r\n    }\r\n\r\n    return res\r\n  };\r\n}\r\n\r\n\r\nexport const mutableHandlers = {\r\n  //\r\n\r\n  get,\r\n  set,\r\n};\r\nexport const shallowReaciveHandlers = {\r\n  get: shallowGet,\r\n  set\r\n};\r\nexport const readonlyHandlers = {\r\n  get: readonlyGet,\r\n  set\r\n  \r\n};\r\nexport const shallowReadonlyHandlers = {\r\n  get: shallowReadonlyGet,\r\n  set\r\n};\r\n","import { mutableHandlers, readonlyHandlers, shallowReaciveHandlers, shallowReadonlyHandlers } from \"./baseHandlers\"\r\nimport {isObject} from \"@vue/shared\"\r\n\r\n\r\nconst reactiveMap = new WeakMap()  // 弱引用 对象key不能用对象  map可以是对象\r\n// weakmap 中的key只能是对象 如果引用的key被置为null weakmap会自动回收\r\nconst readonlyMap = new WeakMap()\r\n\r\nconst shallowReadonlyMap = new  WeakMap()\r\n\r\nconst shallowReactiveMap = new  WeakMap()\r\n\r\nexport function reactive(target:object){\r\n           return createReactiveObject(target,mutableHandlers,reactiveMap)\r\n}\r\n\r\nexport function shallowReacive(target:object){\r\n    return createReactiveObject(target,shallowReaciveHandlers,shallowReactiveMap)\r\n}\r\n\r\nexport function readonly(target:object){\r\n    return createReactiveObject(target,readonlyHandlers,readonlyMap)\r\n}\r\n\r\nexport function shallowReadonly(target:object){\r\n    return createReactiveObject(target,shallowReadonlyHandlers,shallowReadonlyMap)\r\n}\r\n\r\n\r\n\r\nexport function createReactiveObject(target,baseHandlers,proxyMap){\r\n        \r\n    if(!isObject(target)){\r\n        return target\r\n    }\r\n\r\n    // 创建代理对象 \r\n    // const ProxyMap = isReadonly ? readonlyMap : reactiveMap\r\n    const existsProxy = proxyMap.get(target)\r\n    if(existsProxy){\r\n        return existsProxy\r\n    }\r\n    const proxy = new Proxy(target,baseHandlers)\r\n    reactiveMap.set(target,proxy)\r\n    return proxy\r\n}"],"names":[],"mappings":"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"}