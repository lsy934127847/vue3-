{"version":3,"file":"reactivity.cjs.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["export const isObject = (val) => typeof val == \"object\" && val !== null;\r\nexport const isNumber = (val) => typeof val == \"number\";\r\nexport const isFunction = (val) => typeof val == \"function\";\r\nexport const isString = (val) => typeof val == \"string\";\r\nexport const isArray =Array.isArray;\r\nexport const isBoolean = (val) => typeof val == \"boolean\";\r\nexport const extend = Object.assign;\r\n\r\nexport const hasOwn = (target,key) => Object.prototype.hasOwnProperty.call(target,key)\r\nexport const hasChanged =(oldValue,value) =>oldValue !== value\r\nexport const isInteger = (key) => parseInt(key) + \"\" === key","import { isArray, isInteger } from \"@vue/shared\";\r\n\r\nexport function effect(fn,options:any = {}){\r\n\r\n let effect  = createReactiveEffect(fn,options)\r\n if(!options.lazy){\r\n    effect();\r\n }\r\n\r\n return effect\r\n}\r\nlet uid= 0\r\nlet activeEffect\r\nfunction createReactiveEffect(fn,options){\r\n\r\n\r\n     const effect = function(){\r\n        activeEffect = effect\r\n        fn()  // 执行用户传入的函数时 会执行get\r\n        // activeEffect = null\r\n     }\r\n     effect.id = uid++  // 每一个effect都有一个唯一的标识(watcher)\r\n     effect._isEffect = true\r\n     effect.raw = fn\r\n     effect.deps = {}\r\n     effect.options = options\r\n     return effect\r\n}\r\n\r\nconst targetMap = new WeakMap()\r\nexport function track(target,types,key){\r\n\r\n   if(!activeEffect){\r\n       // 说明取值操作时再effect之外操作的\r\n       return \r\n   }\r\n\r\n  let deepsMap =   targetMap.get(target)\r\n  if(!deepsMap){\r\n    targetMap.set(target,(deepsMap = new Map()))\r\n  }\r\n  let dep =  deepsMap.get(key)\r\n  if(!dep){\r\n    deepsMap.set(key,(dep = new Set))\r\n  }\r\n\r\n  if(!dep.has(activeEffect)){\r\n    dep.add(activeEffect)\r\n  }\r\n}\r\n\r\nexport function trigger(target,key,value,type){\r\n\r\n    let deepsMap = targetMap.get(target)\r\n    if(!deepsMap){\r\n            return \r\n    }\r\n    // 如果修改的是数组 并且改的是长度 \r\n    if(isArray(target) && key == \"length\"){\r\n          deepsMap.forEach( (dep,key) =>{\r\n              if(key == \"length\" || value < key){\r\n                  dep.forEach( effects =>effects())\r\n              }\r\n          })\r\n    }else {\r\n        if(type == \"add\"){\r\n            //新增逻辑 需要触发更新\r\n                if(isArray(target) && isInteger(key)){\r\n                    let effects = deepsMap.get(\"length\")\r\n                    effects && effects.forEach(effect =>effect())\r\n                }\r\n        }\r\n        const effects = deepsMap.get(key)\r\n\r\n        effects && effects.forEach( (effect) =>{\r\n            effect()\r\n        })\r\n    }\r\n  \r\n   // activeEffect()\r\n}","import { hasChanged, hasOwn, isArray, isInteger, isObject } from \"../../shared/src/index\";\r\nimport { reactive, readonly } from \"./reactive\";\r\nimport { track, trigger } from \"./effect\"\r\nconst get = createGetter();\r\nconst readonlyGet = createGetter(true); // 仅读get\r\nconst shallowGet = createGetter(false, true); //\r\nconst shallowReadonlyGet = createGetter(true, true);\r\n\r\nconst set = createSetter()\r\n\r\n\r\nfunction createSetter(){\r\n  return function set(target,key,value,receiver){\r\n\r\n    let oldValue = target[key]\r\n\r\n    let hadKey =  isArray(target) && isInteger(key) ? key < target.length :hasOwn(target,key)\r\n\r\n    \r\n\r\n    let res = Reflect.set(target,key,value,receiver)\r\n\r\n    if(!hadKey) {\r\n      // 新增\r\n   }else if(hasChanged(oldValue,value)){\r\n     trigger(target,key,value,\"add\")\r\n   }\r\n\r\n  \r\n    console.log(\"res\",res)\r\n    // 触发视图更新\r\n     return res\r\n  }\r\n}\r\n\r\nfunction createGetter(isReadonly = false, shallow = false) {\r\n  // 目标 属性 代理对象\r\n  return function get(target, key, receiver) {\r\n    let res = Reflect.get(target, key, receiver);\r\n\r\n    if (!isReadonly) {\r\n      // 不是仅读 才去搜集依赖\r\n      track(target,\"get\",key)\r\n    }\r\n    if (shallow) {\r\n      return res;\r\n    }\r\n\r\n    if (isObject(res)) {  // 如果是对象就递归代理 当用到这个对象的时候才去代理\r\n      // {name:\"lsy\",age:{p1:25}} 当取到age的时候才去代理\r\n      return isReadonly ? readonly(res) : reactive(res); // 懒代理\r\n    }\r\n\r\n    return res\r\n  };\r\n}\r\n\r\n\r\nexport const mutableHandlers = {\r\n  //\r\n\r\n  get,\r\n  set,\r\n};\r\nexport const shallowReaciveHandlers = {\r\n  get: shallowGet,\r\n  set\r\n};\r\nexport const readonlyHandlers = {\r\n  get: readonlyGet,\r\n  set\r\n  \r\n};\r\nexport const shallowReadonlyHandlers = {\r\n  get: shallowReadonlyGet,\r\n  set\r\n};\r\n","import { mutableHandlers, readonlyHandlers, shallowReaciveHandlers, shallowReadonlyHandlers } from \"./baseHandlers\"\r\nimport {isObject} from \"@vue/shared\"\r\n\r\n\r\nconst reactiveMap = new WeakMap()  // 弱引用 对象key不能用对象  map可以是对象\r\n// weakmap 中的key只能是对象 如果引用的key被置为null weakmap会自动回收\r\nconst readonlyMap = new WeakMap()\r\n\r\nconst shallowReadonlyMap = new  WeakMap()\r\n\r\nconst shallowReactiveMap = new  WeakMap()\r\n\r\nexport function reactive(target:object){\r\n           return createReactiveObject(target,mutableHandlers,reactiveMap)\r\n}\r\n\r\nexport function shallowReacive(target:object){\r\n    return createReactiveObject(target,shallowReaciveHandlers,shallowReactiveMap)\r\n}\r\n\r\nexport function readonly(target:object){\r\n    return createReactiveObject(target,readonlyHandlers,readonlyMap)\r\n}\r\n\r\nexport function shallowReadonly(target:object){\r\n    return createReactiveObject(target,shallowReadonlyHandlers,shallowReadonlyMap)\r\n}\r\n\r\n\r\n\r\nexport function createReactiveObject(target,baseHandlers,proxyMap){\r\n        \r\n    if(!isObject(target)){\r\n        return target\r\n    }\r\n\r\n    // 创建代理对象 \r\n    // const ProxyMap = isReadonly ? readonlyMap : reactiveMap\r\n    const existsProxy = proxyMap.get(target)\r\n    if(existsProxy){\r\n        return existsProxy\r\n    }\r\n    const proxy = new Proxy(target,baseHandlers)\r\n    reactiveMap.set(target,proxy)\r\n    return proxy\r\n}"],"names":[],"mappings":"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"}